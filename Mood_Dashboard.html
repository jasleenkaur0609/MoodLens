<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MoodLens – Mood History Dashboard</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase Compat Libraries -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// ===== Firebase Initialization =====
const firebaseConfig = {
  apiKey: "AIzaSyAao3A5qY2CfJfSpjJq3VK8pXVgP0HAFCo",
  authDomain: "moodlens-188a5.firebaseapp.com",
  projectId: "moodlens-188a5",
  storageBucket: "moodlens-188a5.firebasestorage.app",
  messagingSenderId: "175504126348",
  appId: "1:175504126348:web:af68e5600665ff99c5a6a9",
  measurementId: "G-7H1HRGEM9T"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<style>
/* ===== GLOBAL RESET ===== */
* { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins', sans-serif; }
body { background: linear-gradient(135deg, #12131a, #1a1b23); color:#fff; overflow-x:hidden; transition: background 1s ease; }

/* ===== CONTAINER ===== */
.container { padding:30px; display:flex; flex-direction:column; gap:25px; }

/* ===== DASHBOARD HEADER ===== */
.dashboard-header { display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; }
.dashboard-header h1 { font-size:2.5rem; font-weight:700; background: linear-gradient(135deg, #f0c674, #b28fff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.filters { display:flex; gap:12px; margin-top:10px; flex-wrap: wrap; }
.filters select, .filters input { padding:8px 12px; border-radius:8px; border:none; outline:none; font-size:0.95rem; background: rgba(255,255,255,0.1); color:#fff; }
.filters select option, .filters input { color:#000; background:#fff; }

/* ===== ANALYTICS SECTION ===== */
.analytics-section { display:grid; grid-template-columns:1fr 1fr; gap:30px; }
@media(max-width:1024px){ .analytics-section { grid-template-columns:1fr; } }

/* ===== GLASS CARD ===== */
.analytics-card { padding:20px; border-radius:18px; background: rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); backdrop-filter: blur(6px); transition: all 0.3s ease; }
.analytics-card:hover { transform: translateY(-5px) scale(1.02); box-shadow:0 0 15px rgba(255,255,255,0.1); }

/* ===== MOOD RING ===== */
.mood-ring-container { position: relative; width:250px; height:250px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; transition: transform 0.4s ease; margin:auto; }
.mood-ring-container span { position:absolute; color:#fff; font-weight:700; text-align:center; }

/* ===== PIE CHART ===== */
.chart-container { max-width:300px; margin:20px auto; }

/* ===== LINE CHART ===== */
.line-chart-container { max-width:500px; margin:20px auto; }

/* ===== HEATMAP ===== */
.heatmap-container { display:flex; flex-direction:column; gap:10px; }
.heatmap { display:grid; grid-template-columns:repeat(7,1fr); gap:5px; }
.heatmap div { width:30px; height:30px; border-radius:6px; background:#1c1c28; transition:all 0.3s ease; position:relative; }
.heatmap div[data-mood="happy"]{ background:#a18e5d; }
.heatmap div[data-mood="sad"]{ background:#5d7aa2; }
.heatmap div[data-mood="angry"]{ background:#a25d5d; }
.heatmap div[data-mood="surprised"]{ background:#8b5da2; }
.heatmap div[data-mood="neutral"]{ background:#7a7a7a; }
.heatmap div:hover::after { content: attr(data-note); position:absolute; background: rgba(0,0,0,0.7); padding:5px 8px; border-radius:6px; font-size:0.75rem; top:-30px; left:-10px; max-width:150px; pointer-events:none; }

/* ===== TIMELINE ===== */
.timeline { display:flex; flex-direction:column; gap:10px; margin-top:10px; max-height:300px; overflow-y:auto; }
.timeline-item { display:flex; align-items:center; gap:10px; padding:10px 14px; border-radius:12px; background: rgba(255,255,255,0.05); border-left:5px solid #f0c674; transition: all 0.4s ease; }
.timeline-item[data-mood="happy"]{ border-left-color:#a18e5d; }
.timeline-item[data-mood="sad"]{ border-left-color:#5d7aa2; }
.timeline-item[data-mood="angry"]{ border-left-color:#a25d5d; }
.timeline-item[data-mood="surprised"]{ border-left-color:#8b5da2; }
.timeline-item[data-mood="neutral"]{ border-left-color:#7a7a7a; }
.timeline-item:hover{ transform: scale(1.02); box-shadow:0 0 15px rgba(255,255,255,0.1); }

/* ===== DOMINANT MOOD CARD ===== */
.dominant-mood { margin:20px 0; padding:15px; background: rgba(255,255,255,0.05); border-radius:12px; text-align:center; font-size:1.2rem; }
</style>
</head>
<body>

<div class="container">
  <div class="dashboard-header">
    <h1>Mood History Dashboard</h1>
    <div class="filters">
      <select id="moodFilter">
        <option value="all">All Moods</option>
        <option value="happy">Happy</option>
        <option value="sad">Sad</option>
        <option value="angry">Angry</option>
        <option value="surprised">Surprised</option>
        <option value="neutral">Neutral</option>
      </select>
      <input type="date" id="dateFilter"/>
    </div>
  </div>

  <!-- Dominant Mood Card -->
  <div class="dominant-mood" id="dominantMood">Loading dominant mood...</div>

  <div class="analytics-section">
    <div>
      <div class="mood-ring-container"><span>Mood Ring</span></div>
      <div class="analytics-card chart-container">
        <canvas id="pieChart"></canvas>
      </div>
      <div class="analytics-card line-chart-container">
        <canvas id="lineChart"></canvas>
      </div>
    </div>

    <div class="analytics-cards">
      <div class="analytics-card heatmap-container">
        <div class="heatmap" id="heatmap"></div>
      </div>
      <div class="analytics-card">
        <div class="timeline" id="timeline"></div>
      </div>
    </div>
  </div>
</div>

<script>
// ===== GLOBAL VARIABLES =====
let moodHistory = [];
const timelineEl = document.getElementById('timeline');
const heatmapEl = document.getElementById('heatmap');
const moodFilter = document.getElementById('moodFilter');
const dateFilter = document.getElementById('dateFilter');
const dominantMoodEl = document.getElementById('dominantMood');
const ctxPie = document.getElementById('pieChart').getContext('2d');
const ctxLine = document.getElementById('lineChart').getContext('2d');

// ===== CHARTS =====
const pieChart = new Chart(ctxPie,{
  type:'doughnut',
  data:{ labels:['Happy','Sad','Angry','Surprised','Neutral'], datasets:[{ data:[0,0,0,0,0], backgroundColor:['#a18e5d','#5d7aa2','#a25d5d','#8b5da2','#7a7a7a'], borderWidth:0 }]},
  options:{ responsive:true, plugins:{legend:{position:'bottom'}}, animation:{animateScale:true, animateRotate:true} }
});

const lineChart = new Chart(ctxLine,{
  type:'line',
  data:{ labels:[], datasets:[{ label:'Mood Trend', data:[], fill:false, borderColor:'#f0c674', tension:0.3 }] },
  options:{ responsive:true, plugins:{legend:{display:false}} }
});

// ===== RENDER FUNCTIONS =====
function renderTimeline(data){
  timelineEl.innerHTML='';
  data.forEach(entry=>{
    const div = document.createElement('div');
    div.className='timeline-item';
    div.dataset.mood = entry.mood;
    let dateStr = entry.date.toDate ? entry.date.toDate().toISOString().split('T')[0] : entry.date;
    div.innerHTML = `<span>${dateStr}</span> – ${entry.note}`;
    timelineEl.appendChild(div);
  });
}

function renderHeatmap(data){
  heatmapEl.innerHTML='';
  data.forEach(entry=>{
    const div = document.createElement('div');
    div.dataset.mood = entry.mood;
    let dateStr = entry.date.toDate ? entry.date.toDate().toISOString().split('T')[0] : entry.date;
    div.dataset.note = `${dateStr}: ${entry.note}`;
    heatmapEl.appendChild(div);
  });
}

function renderPieChart(data){
  const counts = {happy:0,sad:0,angry:0,surprised:0,neutral:0};
  data.forEach(d=>counts[d.mood]++);
  pieChart.data.datasets[0].data = [counts.happy, counts.sad, counts.angry, counts.surprised, counts.neutral];
  pieChart.update();
  // Update dominant mood
  let dominant = Object.keys(counts).reduce((a,b)=>counts[a]>counts[b]?a:b);
  dominantMoodEl.textContent = `Dominant Mood: ${dominant.toUpperCase()}`;
}

function renderLineChart(data){
  let labels = data.map(d => d.date.toDate ? d.date.toDate().toISOString().split('T')[0] : d.date);
  let moodValues = data.map(d => {
    const mapping = {happy:5, surprised:4, neutral:3, sad:2, angry:1};
    return mapping[d.mood] || 3;
  });
  lineChart.data.labels = labels;
  lineChart.data.datasets[0].data = moodValues;
  lineChart.update();
}

// ===== APPLY FILTERS =====
function applyFilters(){
  let filtered = [...moodHistory];
  const moodVal = moodFilter.value;
  const dateVal = dateFilter.value;

  if(moodVal !== 'all') filtered = filtered.filter(d=>d.mood===moodVal);

  if(dateVal){
    filtered = filtered.filter(d=>{
      let docDate = d.date;
      if(typeof docDate !== "string") docDate = docDate.toDate ? docDate.toDate() : new Date(docDate);
      docDate = docDate.toISOString().split('T')[0];
      return docDate === dateVal;
    });
  }

  renderTimeline(filtered);
  renderHeatmap(filtered);
  renderPieChart(filtered);
  renderLineChart(filtered);
}

// ===== FETCH DATA FROM FIRESTORE =====
async function fetchData(){
  try{
    const snapshot = await db.collection("mood").orderBy("date","asc").get();
    moodHistory = snapshot.docs.map(doc=>doc.data());
    applyFilters();
  } catch(err){
    console.error("Error fetching moods:", err);
    alert("Could not fetch data from Firestore. Check your Firebase config and rules.");
  }
}

// ===== INITIALIZE =====
fetchData();

// ===== EVENT LISTENERS =====
moodFilter.addEventListener('change', applyFilters);
dateFilter.addEventListener('change', applyFilters);
</script>
</body>
</html>
